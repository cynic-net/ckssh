#!/usr/bin/env bash
set -Eeuo pipefail
trap 'ec=$?; echo 1>&2 "INTERNAL ERROR: ec=$ec line=$LINENO cmd=$BASH_COMMAND";
      exit $ec;' ERR

fail() { ec=$?; echo "FAILED ($ec)" "$@"; exit $ec; }

export PROJDIR=$(cd "$(dirname "$0")" && pwd -P)
#   We must never use the user's actual $XDG_RUNTIME_DIR when testing
#   so as not to stomp on their current compartments.
export XDG_RUNTIME_DIR=$PROJDIR/.build/run
rm -rf "$XDG_RUNTIME_DIR" \
    && mkdir -p "$XDG_RUNTIME_DIR" && chmod 0700 "$XDG_RUNTIME_DIR"

cd "$PROJDIR"

[[ ${1:-} = -[cC] ]] && { shift; git clean -fdX; }
. ./pactivate -q

PYTHONPATH=bin pytest -qq "$@" t/unit.py t/functional.py || fail pytest

#   Simple form when you expect no messages to stdout
CKSSH_SHELL_INTERFACE_TEST=''
#   `ckcommand` will separate out the stuff to eval and eval it,
#   leaving stdout and stderr working as normal.
ckcommand shell-interface-test >/dev/null 2>&1 \
    || fail ckcommand shell-interface-test
[[ -n $CKSSH_SHELL_INTERFACE_TEST ]] \
    || fail 'CKSSH_SHELL_INTERFACE_TEST not set'

#   Functional testing like this is starting to get painful; we need to
#   find a better way to test this stuff (ideally with unit tests).
#unset SSH_AUTH_SOCK
_compartment=cjs@cynic.net
exitcode=0
actual=$(
    HOME="$PROJDIR/t/mock_home"
    SSH_AUTH_SOCK=/test-xdg-rtdir-nonexistent/ckssh/socket/$_compartment
    ckset -n) || exitcode=$?
[[ $actual = $_compartment ]] || fail \
    "ckset: expected $_compartment, actual '$actual'"
[[ $exitcode -eq 2 ]] || fail "ckset: expected \$?=2, actual \$?=$exitcode"

echo OK
